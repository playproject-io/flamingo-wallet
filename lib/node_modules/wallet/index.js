
const { exec } = require('child_process');

function runCommand(cmd) {
  return new Promise((resolve, reject) => {
    exec(cmd, { maxBuffer: 10 * 1024 * 1024 }, (err, stdout, stderr) => {
      if (err) return reject(stderr || err.message);
      try {
        resolve(JSON.parse(stdout));
      } catch (e) {
        resolve({ raw: stdout.trim() });
      }
    });
  });
}


const api = {
    // Bitcoin
    //start command 'bitcoind -regtest -daemon'
    //end command 'bitcoin-cli -regtest stop'
  async getInfoBitcoin() {
    return runCommand('bitcoin-cli -regtest getblockchaininfo');
  },

  async newBitcoinAddress() {
    return runCommand('bitcoin-cli -regtest getnewaddress');
  },

  async sendBitcoin(address, amount) {
    return runCommand(`bitcoin-cli -regtest sendtoaddress ${address} ${amount}`);
  },

  // Lightning
  //start command 'lightningd --network=regtest'
  //end command 'lightning-cli --network=regtest stop'
  async getInfoLightning() {
    return runCommand('lightning-cli --network=regtest getinfo');
  },

  async newLightningAddress() {
    return runCommand('lightning-cli --network=regtest newaddr');
  },

  async fundChannel(peerId, satoshis) {
    return runCommand(`lightning-cli --network=regtest fundchannel ${peerId} ${satoshis}`);
  }
};

module.exports = api;
